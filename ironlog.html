<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>IRONLOG</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a; --surface: #111; --surface2: #161616;
  --border: #222; --accent: #e8ff47; --red: #ff4d4d;
  --text: #f0f0f0; --muted: #555; --muted2: #2a2a2a;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; overscroll-behavior: none; }
input, select, textarea, button { font-family: 'DM Mono', monospace; -webkit-appearance: none; border-radius: 0; }
button { cursor: pointer; }
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-thumb { background: var(--muted2); }

/* HEADER */
#header {
  position: fixed; top: 0; left: 0; right: 0; height: 52px; z-index: 100;
  background: rgba(10,10,10,0.97); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 4px; color: var(--accent); }
.logo span { color: var(--text); }
.nav { display: flex; gap: 4px; }
.nav-btn {
  font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 12px;
  letter-spacing: 2px; text-transform: uppercase; padding: 6px 12px;
  background: none; border: 1px solid transparent; color: var(--muted); transition: all 0.15s;
}
.nav-btn.active { color: var(--accent); border-color: var(--accent); background: rgba(232,255,71,0.07); }

/* MAIN */
#app { padding-top: 52px; }
.page { display: none; padding: 20px 16px 80px; }
.page.active { display: block; }

/* PAGE HEADING */
.page-title { font-family: 'Bebas Neue', sans-serif; font-size: 38px; letter-spacing: 3px; line-height: 1; }
.page-sub { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin: 4px 0 18px; }

/* DAY TABS */
.day-tabs { display: flex; gap: 2px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 18px; border-bottom: 1px solid var(--border); }
.day-tab {
  font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px;
  padding: 7px 13px; background: none; border: none; color: var(--muted);
  border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.15s;
}
.day-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* PANEL HEADER */
.panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
.panel-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 3px; }

/* BUTTONS */
.btn { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; transition: all 0.15s; border: none; }
.btn-primary { background: var(--accent); color: #000; padding: 10px 20px; font-size: 13px; }
.btn-accent { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 9px 16px; font-size: 13px; }
.btn-ghost { background: none; border: 1px solid var(--border); color: var(--muted); padding: 6px 11px; font-size: 11px; }
.btn-outline { background: none; border: 1px solid var(--muted2); color: var(--muted); padding: 9px 16px; font-size: 13px; }
.btn-dashed { background: none; border: 1px dashed var(--muted2); color: var(--muted); padding: 10px; font-size: 13px; width: 100%; letter-spacing: 2px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; text-transform: uppercase; margin-top: 6px; margin-bottom: 14px; transition: all 0.15s; }

/* EXERCISE CARD */
.ex-card { background: var(--surface); border: 1px solid var(--border); margin-bottom: 10px; }
.ex-card-top { padding: 12px 14px; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
.ex-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; letter-spacing: 1px; text-transform: uppercase; line-height: 1.2; }
.ex-cat { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 3px; }
.ex-actions { display: flex; gap: 5px; flex-shrink: 0; }

/* STATS STRIP */
.stats-strip { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
.stat-cell { padding: 10px 12px; }
.stat-cell + .stat-cell { border-left: 1px solid var(--border); }
.stat-lbl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 5px; }
.stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; line-height: 1; color: var(--text); }
.stat-val.accent { font-size: 22px; color: var(--accent); }

/* SETS PREVIEW */
.sets-preview { padding: 10px 14px; border-bottom: 1px solid var(--border); }
.sets-preview-lbl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 9px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 7px; }
.sets-chips { display: flex; flex-wrap: wrap; gap: 5px; }
.set-chip { background: var(--surface2); border: 1px solid var(--border); padding: 5px 9px; font-size: 12px; display: flex; align-items: center; gap: 3px; }
.chip-num { font-family: 'Bebas Neue', sans-serif; font-size: 13px; color: var(--muted); }
.chip-w { color: var(--accent); font-weight: 500; }
.chip-x { color: var(--muted); }

/* CARD FOOTER */
.ex-card-footer { padding: 11px 14px; display: flex; align-items: center; justify-content: space-between; }
.session-count { font-size: 10px; color: var(--muted); letter-spacing: 1px; }

/* EMPTY STATE */
.empty { text-align: center; padding: 56px 20px; color: var(--muted); }
.empty-icon { font-size: 44px; opacity: 0.15; margin-bottom: 14px; }
.empty-title { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 2px; margin-bottom: 8px; }
.empty-sub { font-size: 12px; }

/* MODAL */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 200;
  align-items: flex-end; justify-content: center;
}
.modal-overlay.open { display: flex; animation: fadeIn 0.18s; }
.modal {
  background: var(--surface); border: 1px solid var(--border); border-bottom: none;
  width: 100%; max-height: 93vh; display: flex; flex-direction: column;
  animation: slideUp 0.22s;
}
.modal-header { padding: 15px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; }
.modal-close { background: none; border: none; color: var(--muted); font-size: 22px; line-height: 1; padding: 2px 8px; }
.modal-body { overflow-y: auto; flex: 1; padding: 18px; -webkit-overflow-scrolling: touch; }
.modal-footer { padding: 12px 18px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; flex-shrink: 0; }

/* FORM ELEMENTS */
.field { margin-bottom: 14px; }
.field-lbl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 9px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
.input, .select-input {
  width: 100%; background: var(--bg); border: 1px solid var(--muted2);
  color: var(--text); padding: 9px 10px; font-size: 14px; outline: none;
  font-family: 'DM Mono', monospace;
}
.input:focus, .select-input:focus { border-color: var(--accent); }

/* UNIT PICKER */
.unit-picker { display: flex; gap: 6px; }
.unit-btn {
  flex: 1; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px;
  letter-spacing: 1.5px; text-transform: uppercase; padding: 9px 6px;
  border: 1px solid var(--muted2); background: none; color: var(--muted); transition: all 0.15s;
}
.unit-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(232,255,71,0.08); }

/* SET ROWS */
.set-cols-header { display: grid; grid-template-columns: 24px 1fr 80px 1fr 26px; gap: 6px; margin-bottom: 5px; align-items: center; }
.set-row { display: grid; grid-template-columns: 24px 1fr 80px 1fr 26px; gap: 6px; margin-bottom: 7px; align-items: center; }
.set-num { font-family: 'Bebas Neue', sans-serif; font-size: 16px; color: var(--accent); text-align: center; letter-spacing: 1px; }
.input-center { text-align: center; font-size: 16px; }
.input-sm { font-size: 12px; color: var(--muted); }
.remove-set-btn { background: none; border: none; color: var(--muted2); font-size: 16px; line-height: 1; padding: 4px 2px; transition: color 0.15s; }
.remove-set-btn:active { color: var(--red); }

/* HINT BOX */
.hint-box { font-size: 11px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 16px; padding: 9px 12px; background: var(--surface2); border-left: 2px solid var(--muted2); }
.hint-box strong { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 4px; }

/* HISTORY SESSION */
.history-session { margin-bottom: 16px; border: 1px solid var(--border); }
.history-session-header { padding: 9px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface2); }
.history-date { font-size: 12px; color: var(--muted); letter-spacing: 1px; }
.unit-badge { font-size: 10px; color: var(--muted); border: 1px solid var(--muted2); padding: 3px 8px; letter-spacing: 1px; text-transform: uppercase; font-family: 'Barlow Condensed', sans-serif; }
.delete-session-btn { background: none; border: none; color: var(--muted2); font-size: 16px; padding: 2px 6px; }
.delete-session-btn:active { color: var(--red); }
.set-table-row { display: grid; grid-template-columns: 36px 1fr 70px 1fr; border-bottom: 1px solid var(--border); }
.set-table-row.pb { background: rgba(232,255,71,0.05); }
.stc { padding: 8px 10px; font-size: 13px; }
.stc + .stc { border-left: 1px solid var(--border); }
.stc.num { font-family: 'Bebas Neue', sans-serif; font-size: 16px; color: var(--accent); }
.stc.w { color: var(--text); font-weight: 500; }
.stc.w.pb-w { color: var(--accent); }
.stc.r {}
.stc.n { font-size: 11px; color: var(--muted); }
.session-notes { padding: 8px 12px; font-size: 11px; color: var(--muted); font-style: italic; border-top: 1px solid var(--border); }

/* ANALYSIS */
.summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 22px; }
.summary-box { background: var(--surface); border: 1px solid var(--border); padding: 14px 16px; }
.summary-lbl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 9px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.summary-val { font-family: 'Bebas Neue', sans-serif; font-size: 30px; color: var(--accent); letter-spacing: 2px; line-height: 1; }
.filter-row { display: flex; gap: 8px; margin-bottom: 20px; }
.an-card { background: var(--surface); border: 1px solid var(--border); padding: 14px; margin-bottom: 12px; }
.an-card-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
.an-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; letter-spacing: 1px; text-transform: uppercase; }
.an-day { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
.an-pb-val { font-family: 'Bebas Neue', sans-serif; font-size: 26px; color: var(--accent); letter-spacing: 2px; line-height: 1; text-align: right; }
.an-pb-lbl { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; text-align: right; }
.vol-bar-wrap { height: 2px; background: var(--border); margin-bottom: 10px; }
.vol-bar { height: 100%; background: var(--accent); }
.an-stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.an-stat-lbl { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 4px; }
.an-stat-val { font-size: 13px; color: var(--text); }
.an-stat-val.hi { color: var(--accent); }
.an-sets-preview { padding-top: 10px; border-top: 1px solid var(--border); }

/* TOAST */
#toast {
  position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%);
  background: var(--accent); color: #000; font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700; font-size: 13px; letter-spacing: 2px; text-transform: uppercase;
  padding: 10px 22px; z-index: 999; white-space: nowrap; pointer-events: none;
  opacity: 0; transition: opacity 0.2s;
}
#toast.show { opacity: 1; }

/* DIVIDER */
.or-divider { text-align: center; color: var(--muted); font-size: 11px; letter-spacing: 1px; margin: 10px 0; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">IRON<span>LOG</span></div>
  <div class="nav">
    <button class="nav-btn active" onclick="showPage('workout')">Workouts</button>
    <button class="nav-btn" onclick="showPage('analysis')">Analysis</button>
  </div>
</div>

<div id="app">
  <!-- WORKOUT PAGE -->
  <div class="page active" id="page-workout">
    <div class="page-title">WEEKLY<br>PROGRAM</div>
    <div class="page-sub">Log each set with its own weight & reps</div>
    <div class="day-tabs" id="dayTabs"></div>
    <div id="dayPanels"></div>
  </div>

  <!-- ANALYSIS PAGE -->
  <div class="page" id="page-analysis">
    <div class="page-title">ANALYSIS</div>
    <div class="page-sub">Personal bests & progress overview</div>
    <div class="summary-grid" id="summaryGrid"></div>
    <div class="filter-row">
      <input class="input" id="searchInput" placeholder="Search exercise..." oninput="renderAnalysis()" style="flex:1">
      <select class="select-input" id="dayFilter" onchange="renderAnalysis()" style="width:auto">
        <option value="">All Days</option>
        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
        <option>Thursday</option><option>Friday</option><option>Saturday</option>
      </select>
    </div>
    <div id="analysisCards"></div>
  </div>
</div>

<!-- ADD EXERCISE MODAL -->
<div class="modal-overlay" id="addExModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add Exercise</span>
      <button class="modal-close" onclick="closeModal('addExModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <div class="field-lbl">Choose from library</div>
        <select class="select-input" id="exLibrary" onchange="onLibraryPick()">
          <option value="">‚Äî Select exercise ‚Äî</option>
          <optgroup label="CHEST">
            <option>Barbell Bench Press</option><option>Dumbbell Bench Press</option>
            <option>Incline Barbell Press</option><option>Incline Dumbbell Press</option>
            <option>Decline Bench Press</option><option>Cable Crossover</option>
            <option>Chest Dips</option><option>Pec Deck / Chest Fly</option><option>Push-Up</option>
          </optgroup>
          <optgroup label="BACK">
            <option>Deadlift</option><option>Barbell Row</option><option>Dumbbell Row</option>
            <option>T-Bar Row</option><option>Lat Pulldown</option><option>Pull-Up / Chin-Up</option>
            <option>Seated Cable Row</option><option>Face Pull</option><option>Rack Pull</option>
            <option>Romanian Deadlift</option>
          </optgroup>
          <optgroup label="SHOULDERS">
            <option>Overhead Press (Barbell)</option><option>Dumbbell Shoulder Press</option>
            <option>Arnold Press</option><option>Lateral Raise</option><option>Front Raise</option>
            <option>Rear Delt Fly</option><option>Upright Row</option><option>Cable Lateral Raise</option>
            <option>Shrugs</option>
          </optgroup>
          <optgroup label="LEGS">
            <option>Barbell Squat</option><option>Front Squat</option><option>Hack Squat</option>
            <option>Leg Press</option><option>Bulgarian Split Squat</option><option>Lunges</option>
            <option>Leg Extension</option><option>Leg Curl (Lying)</option><option>Leg Curl (Seated)</option>
            <option>Hip Thrust</option><option>Calf Raise (Standing)</option><option>Calf Raise (Seated)</option>
            <option>Sumo Deadlift</option>
          </optgroup>
          <optgroup label="BICEPS">
            <option>Barbell Curl</option><option>Dumbbell Curl</option><option>Incline Dumbbell Curl</option>
            <option>Hammer Curl</option><option>Preacher Curl</option><option>Cable Curl</option>
            <option>Concentration Curl</option><option>EZ-Bar Curl</option>
          </optgroup>
          <optgroup label="TRICEPS">
            <option>Close-Grip Bench Press</option><option>Tricep Pushdown (Cable)</option>
            <option>Skull Crushers</option><option>Overhead Tricep Extension</option>
            <option>Dips (Tricep)</option><option>Kickbacks</option><option>Diamond Push-Up</option>
          </optgroup>
          <optgroup label="CORE">
            <option>Plank</option><option>Cable Crunch</option><option>Hanging Leg Raise</option>
            <option>Ab Wheel Rollout</option><option>Russian Twist</option><option>Decline Sit-Up</option>
          </optgroup>
          <optgroup label="COMPOUND / POWER">
            <option>Power Clean</option><option>Snatch</option><option>Clean and Press</option>
            <option>Farmer's Carry</option><option>Sled Push</option>
          </optgroup>
        </select>
      </div>
      <div class="or-divider">‚Äî OR TYPE CUSTOM ‚Äî</div>
      <div class="field">
        <div class="field-lbl">Custom name</div>
        <input class="input" id="exCustom" placeholder="e.g. Landmine Press" oninput="onCustomType()">
      </div>
      <div class="field">
        <div class="field-lbl">Category (optional)</div>
        <select class="select-input" id="exCategory">
          <option value="">None</option>
          <option>Chest</option><option>Back</option><option>Shoulders</option>
          <option>Legs</option><option>Biceps</option><option>Triceps</option>
          <option>Core</option><option>Compound / Power</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('addExModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddExercise()">Add Exercise</button>
    </div>
  </div>
</div>

<!-- LOG SESSION MODAL -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="logModalTitle">Log Sets</span>
      <button class="modal-close" onclick="closeModal('logModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <div class="field-lbl">Unit</div>
        <div class="unit-picker">
          <button class="unit-btn active" id="unit-kg" onclick="setUnit('kg')">kg</button>
          <button class="unit-btn" id="unit-lbs" onclick="setUnit('lbs')">lbs</button>
          <button class="unit-btn" id="unit-bw" onclick="setUnit('bw')">Body wt</button>
        </div>
      </div>
      <div id="lastSessionHint" style="display:none" class="hint-box">
        <strong>Last session (pre-filled)</strong>
        <span id="lastSessionText"></span>
      </div>
      <div class="set-cols-header">
        <div></div>
        <div class="field-lbl" id="weightColLbl">Weight</div>
        <div class="field-lbl">Reps</div>
        <div class="field-lbl">Note</div>
        <div></div>
      </div>
      <div id="setRows"></div>
      <button class="btn-dashed" id="addSetBtn" onclick="addSetRow()">+ Add Set</button>
      <div class="field">
        <div class="field-lbl">Session notes (optional)</div>
        <input class="input" id="sessionNotes" placeholder="e.g. felt strong, new grip...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('logModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSession()">Save Session üí™</button>
    </div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="historyModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="historyModalTitle">History</span>
      <button class="modal-close" onclick="closeModal('historyModal')">‚úï</button>
    </div>
    <div class="modal-body" id="historyModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('historyModal')">Close</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ============================================================
// DATA ‚Äî all persisted in localStorage
// ============================================================
const STORAGE_KEY = 'ironlog_v3';

function loadData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
  catch(e) { return {}; }
}
function saveData(d) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
  catch(e) { showToast('Storage full ‚Äî clear some data'); }
}
function getDay(day) {
  const d = loadData();
  if (!d[day]) d[day] = { exercises: [] };
  return d[day];
}
function updateDay(day, dayData) {
  const d = loadData();
  d[day] = dayData;
  saveData(d);
}

// ============================================================
// HELPERS
// ============================================================
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

function fmtDate(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'2-digit' });
}

function getPB(ex) {
  const allSets = (ex.sessions||[]).flatMap(s => s.sets.map(set => ({...set, unit:s.unit, date:s.date, sid:s.id})));
  if (!allSets.length) return null;
  return allSets.reduce((best, s) => {
    const score = s.unit === 'bw' ? s.reps : s.weight * (1 + s.reps / 30);
    const bscore = best ? (best.unit === 'bw' ? best.reps : best.weight * (1 + best.reps / 30)) : -1;
    return score > bscore ? s : best;
  }, null);
}

function getLastSession(ex) {
  if (!ex.sessions || !ex.sessions.length) return null;
  return ex.sessions.reduce((l, c) => new Date(c.date) > new Date(l.date) ? c : l);
}

function getBestSetOfSession(session) {
  if (!session || !session.sets.length) return null;
  return session.sets.reduce((b, s) => {
    const sc = session.unit === 'bw' ? s.reps : s.weight * (1 + s.reps / 30);
    const bs = b ? (session.unit === 'bw' ? b.reps : b.weight * (1 + b.reps / 30)) : -1;
    return sc > bs ? s : b;
  }, null);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'analysis') renderAnalysis();
}

// ============================================================
// BUILD DAY TABS & PANELS
// ============================================================
let activeDay = 'Monday';

function buildTabs() {
  const tabsEl = document.getElementById('dayTabs');
  const panelsEl = document.getElementById('dayPanels');
  tabsEl.innerHTML = '';
  panelsEl.innerHTML = '';
  DAYS.forEach((day, i) => {
    const tab = document.createElement('button');
    tab.className = 'day-tab' + (i === 0 ? ' active' : '');
    tab.textContent = day.slice(0,3).toUpperCase();
    tab.onclick = () => switchDay(day);
    tabsEl.appendChild(tab);

    const panel = document.createElement('div');
    panel.id = 'panel-' + day;
    panelsEl.appendChild(panel);
  });
  renderDay('Monday');
}

function switchDay(day) {
  activeDay = day;
  document.querySelectorAll('.day-tab').forEach((t, i) => t.classList.toggle('active', DAYS[i] === day));
  renderDay(day);
}

// ============================================================
// RENDER DAY PANEL
// ============================================================
function renderDay(day) {
  const panel = document.getElementById('panel-' + day);
  if (!panel) return;
  const dayData = getDay(day);
  const exercises = dayData.exercises || [];

  let html = `<div class="panel-header">
    <div class="panel-title">${day.toUpperCase()}</div>
    <button class="btn btn-accent" onclick="openAddExModal()">+ Add Exercise</button>
  </div>`;

  if (!exercises.length) {
    html += `<div class="empty">
      <div class="empty-icon">üèãÔ∏è</div>
      <div class="empty-title">No exercises yet</div>
      <div class="empty-sub">Add your first exercise for ${day}</div>
    </div>`;
  } else {
    exercises.forEach((ex, exIdx) => {
      const pb = getPB(ex);
      const last = getLastSession(ex);
      const lastBest = getBestSetOfSession(last);
      const sessionCount = (ex.sessions||[]).length;

      const pbVal = pb ? (pb.unit === 'bw' ? `${pb.reps} reps` : `${pb.weight} ${pb.unit}`) : '‚Äî';
      const lastBestVal = last && lastBest ? (last.unit === 'bw' ? `BW√ó${lastBest.reps}` : `${lastBest.weight}${last.unit}√ó${lastBest.reps}`) : '‚Äî';
      const lastDate = last ? fmtDate(last.date) : '‚Äî';

      let chipsHtml = '';
      if (last) {
        chipsHtml = `<div class="sets-preview">
          <div class="sets-preview-lbl">Last session sets</div>
          <div class="sets-chips">
            ${last.sets.map((s,i) => `<div class="set-chip">
              <span class="chip-num">S${i+1}</span>
              <span class="chip-w">${last.unit==='bw'?'BW':s.weight+last.unit}</span>
              <span class="chip-x">√ó</span>
              <span>${s.reps}</span>
            </div>`).join('')}
          </div>
        </div>`;
      }

      html += `<div class="ex-card">
        <div class="ex-card-top">
          <div style="flex:1;min-width:0">
            <div class="ex-name">${escHtml(ex.name)}</div>
            ${ex.category ? `<div class="ex-cat">${escHtml(ex.category)}</div>` : ''}
          </div>
          <div class="ex-actions">
            <button class="btn btn-ghost" onclick="openHistory('${day}',${exIdx})">History</button>
            <button class="btn btn-ghost" onclick="deleteExercise('${day}',${exIdx})">Remove</button>
          </div>
        </div>
        <div class="stats-strip">
          <div class="stat-cell">
            <div class="stat-lbl">Personal Best</div>
            <div class="stat-val ${pb?'accent':''}">${escHtml(pbVal)}</div>
          </div>
          <div class="stat-cell">
            <div class="stat-lbl">Last Best Set</div>
            <div class="stat-val">${escHtml(lastBestVal)}</div>
          </div>
          <div class="stat-cell">
            <div class="stat-lbl">Last Session</div>
            <div class="stat-val">${lastDate}</div>
          </div>
        </div>
        ${chipsHtml}
        <div class="ex-card-footer">
          <div class="session-count">${sessionCount} session${sessionCount!==1?'s':''} total</div>
          <button class="btn btn-primary" onclick="openLogModal('${day}',${exIdx})" style="font-size:12px;padding:9px 18px">+ Log Today's Sets</button>
        </div>
      </div>`;
    });
  }

  panel.innerHTML = html;
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// ADD EXERCISE MODAL
// ============================================================
function openAddExModal() {
  document.getElementById('exLibrary').value = '';
  document.getElementById('exCustom').value = '';
  document.getElementById('exCategory').value = '';
  openModal('addExModal');
}
function onLibraryPick() {
  if (document.getElementById('exLibrary').value) document.getElementById('exCustom').value = '';
}
function onCustomType() {
  if (document.getElementById('exCustom').value) document.getElementById('exLibrary').value = '';
}
function confirmAddExercise() {
  const lib = document.getElementById('exLibrary').value;
  const custom = document.getElementById('exCustom').value.trim();
  const cat = document.getElementById('exCategory').value;
  const name = lib || custom;
  if (!name) { alert('Pick or type an exercise name.'); return; }
  const dayData = getDay(activeDay);
  if (dayData.exercises.find(e => e.name.toLowerCase() === name.toLowerCase())) {
    alert('Already added for this day.'); return;
  }
  dayData.exercises.push({ id: uid(), name, category: cat, sessions: [] });
  updateDay(activeDay, dayData);
  closeModal('addExModal');
  renderDay(activeDay);
  showToast('Exercise added!');
}

// ============================================================
// LOG SESSION MODAL
// ============================================================
let logCtx = { day: null, exIdx: null, unit: 'kg', setCount: 0 };

function openLogModal(day, exIdx) {
  logCtx = { day, exIdx, unit: 'kg', setCount: 3 };
  const dayData = getDay(day);
  const ex = dayData.exercises[exIdx];
  const last = getLastSession(ex);

  document.getElementById('logModalTitle').textContent = 'Log: ' + ex.name;
  document.getElementById('sessionNotes').value = '';

  // Unit buttons
  setUnit(last ? last.unit : 'kg', true);

  // Pre-fill from last session
  const setRows = document.getElementById('setRows');
  setRows.innerHTML = '';
  logCtx.setCount = 0;

  if (last) {
    // Show hint
    const hint = document.getElementById('lastSessionHint');
    hint.style.display = 'block';
    document.getElementById('lastSessionText').textContent = last.sets.map((s,i)=>
      `S${i+1}: ${last.unit==='bw'?'BW':s.weight+last.unit} √ó ${s.reps}`
    ).join('  ¬∑  ');
    // Pre-fill rows
    last.sets.slice(0,5).forEach(s => addSetRow(last.unit==='bw'?'':s.weight, s.reps));
    while (logCtx.setCount < 3) addSetRow();
  } else {
    document.getElementById('lastSessionHint').style.display = 'none';
    addSetRow(); addSetRow(); addSetRow();
  }

  updateAddSetBtn();
  openModal('logModal');
}

function setUnit(u, silent) {
  logCtx.unit = u;
  ['kg','lbs','bw'].forEach(x => {
    document.getElementById('unit-'+x)?.classList.toggle('active', x === u);
  });
  const isBw = u === 'bw';
  document.getElementById('weightColLbl').textContent = isBw ? 'Bodyweight' : 'Weight';
  // Update existing weight inputs
  document.querySelectorAll('.weight-inp').forEach(inp => {
    inp.disabled = isBw;
    inp.value = isBw ? '' : inp.value;
    inp.placeholder = isBw ? '‚Äî' : '0.0';
    inp.style.background = isBw ? 'var(--muted2)' : 'var(--bg)';
    inp.style.color = isBw ? 'var(--muted)' : 'var(--accent)';
  });
}

function addSetRow(prefillWeight, prefillReps) {
  if (logCtx.setCount >= 5) return;
  logCtx.setCount++;
  const n = logCtx.setCount;
  const isBw = logCtx.unit === 'bw';
  const row = document.createElement('div');
  row.className = 'set-row';
  row.id = 'set-row-' + n;
  row.innerHTML = `
    <div class="set-num">${n}</div>
    <input type="number" class="input input-center weight-inp" placeholder="${isBw?'‚Äî':'0.0'}"
      value="${prefillWeight!==undefined&&!isBw?prefillWeight:''}"
      ${isBw?'disabled':''} inputmode="decimal"
      style="color:${isBw?'var(--muted)':'var(--accent)'};background:${isBw?'var(--muted2)':'var(--bg)'}">
    <input type="number" class="input input-center" placeholder="0"
      value="${prefillReps!==undefined?prefillReps:''}" inputmode="numeric">
    <input type="text" class="input input-sm" placeholder="note...">
    <button class="remove-set-btn" onclick="removeSetRow(${n})" ${n<=1?'disabled':''}>‚úï</button>`;
  document.getElementById('setRows').appendChild(row);
  updateAddSetBtn();
}

function removeSetRow(n) {
  const row = document.getElementById('set-row-' + n);
  if (row) { row.remove(); logCtx.setCount--; }
  // Re-number remaining rows
  const rows = document.querySelectorAll('.set-row');
  logCtx.setCount = 0;
  rows.forEach(r => {
    logCtx.setCount++;
    const newN = logCtx.setCount;
    r.id = 'set-row-' + newN;
    r.querySelector('.set-num').textContent = newN;
    const removeBtn = r.querySelector('.remove-set-btn');
    removeBtn.setAttribute('onclick', `removeSetRow(${newN})`);
    removeBtn.disabled = newN <= 1;
  });
  updateAddSetBtn();
}

function updateAddSetBtn() {
  const btn = document.getElementById('addSetBtn');
  if (!btn) return;
  if (logCtx.setCount >= 5) {
    btn.textContent = 'Max 5 sets reached';
    btn.disabled = true;
    btn.style.opacity = '0.4';
  } else {
    btn.textContent = `+ Add Set ${logCtx.setCount + 1}`;
    btn.disabled = false;
    btn.style.opacity = '1';
  }
}

function saveSession() {
  const rows = document.querySelectorAll('.set-row');
  const isBw = logCtx.unit === 'bw';
  const sets = [];
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const weight = parseFloat(inputs[0].value);
    const reps = parseInt(inputs[1].value);
    const notes = inputs[2].value.trim();
    if (isBw) {
      if (reps > 0) sets.push({ id: uid(), weight: 0, reps, notes });
    } else {
      if (weight > 0 && reps > 0) sets.push({ id: uid(), weight, reps, notes });
    }
  });
  if (!sets.length) { alert('Fill in at least one set with weight and reps.'); return; }

  const session = {
    id: uid(),
    date: new Date().toISOString(),
    unit: logCtx.unit,
    sets,
    sessionNotes: document.getElementById('sessionNotes').value.trim(),
  };

  const dayData = getDay(logCtx.day);
  dayData.exercises[logCtx.exIdx].sessions = dayData.exercises[logCtx.exIdx].sessions || [];
  dayData.exercises[logCtx.exIdx].sessions.push(session);
  updateDay(logCtx.day, dayData);
  closeModal('logModal');
  renderDay(logCtx.day);
  showToast(`Session saved ‚Äî ${sets.length} sets logged üí™`);
}

// ============================================================
// HISTORY MODAL
// ============================================================
let histCtx = { day: null, exIdx: null };

function openHistory(day, exIdx) {
  histCtx = { day, exIdx };
  renderHistoryModal();
  openModal('historyModal');
}

function renderHistoryModal() {
  const dayData = getDay(histCtx.day);
  const ex = dayData.exercises[histCtx.exIdx];
  document.getElementById('historyModalTitle').textContent = ex.name;
  const pb = getPB(ex);
  const sessions = [...(ex.sessions||[])].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const body = document.getElementById('historyModalBody');

  if (!sessions.length) {
    body.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px 0">No sessions logged yet.</div>';
    return;
  }

  body.innerHTML = sessions.map(session => {
    const setRows = session.sets.map((set, si) => {
      const isPB = pb && pb.sid === session.id && pb.id === set.id;
      return `<div class="set-table-row ${isPB?'pb':''}">
        <div class="stc num">${si+1}${isPB?'<span style="font-size:10px">‚òÖ</span>':''}</div>
        <div class="stc w ${isPB?'pb-w':''}">${session.unit==='bw'?'BW':set.weight+' '+session.unit}</div>
        <div class="stc r">${set.reps} reps</div>
        <div class="stc n">${escHtml(set.notes||'‚Äî')}</div>
      </div>`;
    }).join('');

    return `<div class="history-session">
      <div class="history-session-header">
        <span class="history-date">${fmtDate(session.date)}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="unit-badge">${session.unit}</span>
          <button class="delete-session-btn" onclick="deleteSession('${session.id}')">‚úï</button>
        </div>
      </div>
      ${setRows}
      ${session.sessionNotes ? `<div class="session-notes">${escHtml(session.sessionNotes)}</div>` : ''}
    </div>`;
  }).join('');
}

function deleteSession(sessionId) {
  if (!confirm('Delete this session?')) return;
  const dayData = getDay(histCtx.day);
  const ex = dayData.exercises[histCtx.exIdx];
  ex.sessions = (ex.sessions||[]).filter(s => s.id !== sessionId);
  updateDay(histCtx.day, dayData);
  renderHistoryModal();
  renderDay(histCtx.day);
  showToast('Session deleted');
}

function deleteExercise(day, exIdx) {
  if (!confirm('Remove this exercise and all its sessions?')) return;
  const dayData = getDay(day);
  dayData.exercises.splice(exIdx, 1);
  updateDay(day, dayData);
  renderDay(day);
  showToast('Removed');
}

// ============================================================
// MODAL HELPERS
// ============================================================
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.remove('open');
  }
});

// ============================================================
// ANALYSIS
// ============================================================
function renderAnalysis() {
  const data = loadData();
  const search = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const dayF = document.getElementById('dayFilter')?.value||'';

  // Summary
  let totalEx=0, totalSets=0, totalVol=0, activeDays=0;
  DAYS.forEach(day => {
    const exs = data[day]?.exercises||[];
    let has = false;
    exs.forEach(ex => {
      totalEx++;
      (ex.sessions||[]).forEach(s => {
        has = true;
        s.sets.forEach(set => {
          totalSets++;
          if (s.unit !== 'bw') totalVol += set.weight * set.reps;
        });
      });
    });
    if (has) activeDays++;
  });

  document.getElementById('summaryGrid').innerHTML =
    [['Exercises',totalEx],['Total Sets',totalSets],['Volume (t)',+(totalVol/1000).toFixed(1)],['Active Days',activeDays]]
    .map(([l,v]) => `<div class="summary-box"><div class="summary-lbl">${l}</div><div class="summary-val">${v}</div></div>`).join('');

  // Cards
  let all = [];
  DAYS.forEach(day => {
    if (dayF && day !== dayF) return;
    (data[day]?.exercises||[]).forEach(ex => {
      if (search && !ex.name.toLowerCase().includes(search)) return;
      all.push({ day, ex });
    });
  });

  const maxVol = Math.max(1, ...all.map(({ex}) =>
    (ex.sessions||[]).reduce((sum,s)=>sum+s.sets.reduce((ss,set)=>ss+(s.unit!=='bw'?set.weight*set.reps:0),0),0)
  ));

  if (!all.length) {
    document.getElementById('analysisCards').innerHTML = `<div class="empty">
      <div class="empty-icon">üìä</div>
      <div class="empty-title">No data yet</div>
      <div class="empty-sub">Log some sessions to see your analysis</div>
    </div>`;
    return;
  }

  document.getElementById('analysisCards').innerHTML = all.map(({day, ex}) => {
    const pb = getPB(ex);
    const last = getLastSession(ex);
    const lastBest = getBestSetOfSession(last);
    const vol = (ex.sessions||[]).reduce((sum,s)=>sum+s.sets.reduce((ss,set)=>ss+(s.unit!=='bw'?set.weight*set.reps:0),0),0);
    const pct = Math.round(vol/maxVol*100);
    const totalS = (ex.sessions||[]).reduce((s,sess)=>s+sess.sets.length,0);

    const pbVal = pb ? (pb.unit==='bw'?`${pb.reps} reps`:pb.weight+' '+pb.unit) : '‚Äî';
    const lastBestVal = last&&lastBest ? (last.unit==='bw'?`BW√ó${lastBest.reps}`:`${lastBest.weight}${last.unit}√ó${lastBest.reps}`) : '‚Äî';

    const chipsHtml = last ? `<div class="an-sets-preview">
      <div class="an-stat-lbl" style="margin-bottom:6px">Last Session</div>
      <div class="sets-chips">
        ${last.sets.map((s,i)=>`<div class="set-chip"><span class="chip-num">S${i+1}</span><span class="chip-w">${last.unit==='bw'?'BW':s.weight+last.unit}</span><span class="chip-x">√ó</span><span>${s.reps}</span></div>`).join('')}
      </div></div>` : '';

    return `<div class="an-card">
      <div class="an-card-top">
        <div>
          <div class="an-name">${escHtml(ex.name)}</div>
          <div class="an-day">${day}${ex.category?' ¬∑ '+ex.category:''}</div>
        </div>
        ${pb?`<div><div class="an-pb-val">${escHtml(pbVal)}</div><div class="an-pb-lbl">‚òÖ PB</div></div>`:''}
      </div>
      <div class="vol-bar-wrap"><div class="vol-bar" style="width:${pct}%"></div></div>
      <div class="an-stats">
        <div><div class="an-stat-lbl">Last Best Set</div><div class="an-stat-val hi">${escHtml(lastBestVal)}</div></div>
        <div><div class="an-stat-lbl">Last Date</div><div class="an-stat-val">${last?fmtDate(last.date):'‚Äî'}</div></div>
        <div><div class="an-stat-lbl">Total Sets</div><div class="an-stat-val">${totalS}</div></div>
        <div><div class="an-stat-lbl">Sessions</div><div class="an-stat-val">${(ex.sessions||[]).length}</div></div>
      </div>
      ${chipsHtml}
    </div>`;
  }).join('');
}

// ============================================================
// INIT
// ============================================================
buildTabs();
</script>
</body>
</html>
